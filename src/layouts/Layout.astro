---
import ar from "../locales/ar.json";
import en from "../locales/en.json";

import "../styles/global.css";

const { title, lang = "ar" } = Astro.props;
const url = Astro.url;
const t = lang === "en" ? en : ar;
const { fullWidth = false } = Astro.props;

---

<html lang={lang} dir={lang === "ar" ? "rtl" : "ltr"} class="bg-gray-50 text-gray-900">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{Astro.props.title || t.siteName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  </head>

  <body class="font-[Cairo]">
    <!-- Header -->
    <header class="bg-blue-900 text-white sticky top-0 z-50">
      <div class="max-w-6xl mx-auto flex justify-between items-center py-4 px-6">
        <!-- Logo -->
        <h2 class="text-2xl font-bold">{t.siteName}</h2>

        <!-- Navigation -->
        <nav class="flex gap-4">
          <a href={`/${lang}`} class="hover:text-blue-300 font-semibold">{t.menu.home}</a>
          <a href={`/${lang}/about`} class="hover:text-blue-300 font-semibold">{t.menu.about}</a>
          <a href={`/${lang}/products`} class="hover:text-blue-300 font-semibold">{t.menu.products}</a>
          <a href={`/${lang}/gallery`} class="hover:text-blue-300 font-semibold">{t.menu.gallery}</a>
          <a href={`/${lang}/contact`} class="hover:text-blue-300 font-semibold">{t.menu.contact}</a>
        </nav>

        <!-- Search and Language Switch -->
        <div class="flex items-center gap-4">
          <!-- Search Dropdown -->
          <div class="relative">
            <input 
              type="text" 
              id="searchInput"
              placeholder={lang === "ar" ? "البحث..." : "Search..."}
              class="px-4 py-2 pr-10 rounded-lg text-gray-900 bg-white border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-500 w-64 shadow-sm"
              autocomplete="off"
            />
            <button 
              id="searchBtn"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </button>
            
            <!-- Search Results Dropdown -->
            <div id="searchResults" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden z-50 max-h-96 overflow-y-auto">
              <div id="searchResultsContent" class="p-2">
                <!-- Results will be populated here -->
              </div>
            </div>
          </div>

          <!-- Language Switch -->
          {lang === "ar" ? (
            <a href={url.pathname.replace('/ar', '/en')} class="bg-white text-blue-900 px-3 py-1 rounded hover:bg-gray-100 transition-colors">
              EN
            </a>
          ) : (
            <a href={url.pathname.replace('/en', '/ar')} class="bg-white text-blue-900 px-3 py-1 rounded hover:bg-gray-100 transition-colors">
              ع
            </a>
          )}
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class={`${fullWidth ? "w-full p-0" : "max-w-6xl mx-auto py-8 px-4"}`}>
      <slot /> 
    </main>

    <!-- Footer -->
    <footer class="bg-blue-900 text-white">
      <div class="container mx-auto px-8 py-4 flex justify-between items-center border-t border-blue-700">
        <!-- Payment Methods Section -->
        <div class="">
          <div class="flex justify-center items-center gap-2 flex-wrap">
            <!-- Visa -->
            <div class="bg-white rounded-lg p-2 shadow-md w-12 h-12">
              <img src="/logos/visa.png" alt="Visa" class="w-full h-full" />
            </div>
            
            <!-- Mastercard -->
            <div class="bg-white rounded-lg p-2 shadow-md w-12 h-12">
              <img src="/logos/master-card.png" alt="Mastercard" class="w-full h-full" />
            </div>
            
            <!-- PayPal -->
            <div class="bg-white rounded-lg p-2 shadow-md w-12 h-12">
              <img src="/logos/paypal.png" alt="paypal" class="w-full h-full" />
            </div>
            
            <!-- Apple Pay -->
            <div class="bg-white rounded-lg p-2 shadow-md w-12 h-12">
              <img src="/logos/apple-pay.png" alt="apple-pay" class="w-full h-full" />
            </div>
          </div>
        </div>
        
        <!-- Copyright -->
        <div class="text-center pt-4">
          <p>{t.footer.rights}</p>
        </div>
      </div>
    </footer>

    <!-- Search Functionality -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput') as HTMLInputElement;
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const searchResultsContent = document.getElementById('searchResultsContent');
        
        if (!searchInput || !searchBtn || !searchResults || !searchResultsContent) return;
        
        // Define searchable content
        const searchableContent = [
          {
            page: window.location.pathname.includes('/en') ? "Home" : "الرئيسية",
            url: window.location.pathname.includes('/en') ? "/en" : "/ar",
            sections: [
              {
                title: window.location.pathname.includes('/en') ? "Welcome to Mesk Pools" : "مرحباً بكم في مسك بولي",
                content: window.location.pathname.includes('/en') ? "We specialize in designing, building and maintaining pools" : "نحن متخصصون في تصميم وبناء وصيانة المسابح",
                keywords: ["مسبح", "pool", "تصميم", "design", "بناء", "building", "صيانة", "maintenance"]
              },
              {
                title: window.location.pathname.includes('/en') ? "Our Statistics" : "إحصائياتنا",
                content: window.location.pathname.includes('/en') ? "Over 500 completed projects and 15 years of experience" : "أكثر من 500 مشروع مكتمل و15 سنة خبرة",
                keywords: ["إحصائيات", "statistics", "مشاريع", "projects", "خبرة", "experience"]
              }
            ]
          },
          {
            page: window.location.pathname.includes('/en') ? "About Us" : "من نحن",
            url: window.location.pathname.includes('/en') ? "/en/about" : "/ar/about",
            sections: [
              {
                title: window.location.pathname.includes('/en') ? "Our Story" : "قصتنا",
                content: window.location.pathname.includes('/en') ? "Years of experience in the pool industry" : "خبرة سنوات في مجال المسابح",
                keywords: ["خبرة", "experience", "سنوات", "years", "مجال", "industry"]
              }
            ]
          },
          {
            page: window.location.pathname.includes('/en') ? "Products & Services" : "المنتجات والخدمات",
            url: window.location.pathname.includes('/en') ? "/en/products" : "/ar/products",
            sections: [
              {
                title: window.location.pathname.includes('/en') ? "Water Filters" : "فلاتر المياه",
                content: window.location.pathname.includes('/en') ? "High quality filters for pool water purification" : "فلاتر عالية الجودة لتنقية مياه المسابح",
                keywords: ["فلتر", "filter", "تنقية", "purification", "مياه", "water"]
              },
              {
                title: window.location.pathname.includes('/en') ? "Water Pumps" : "مضخات المياه",
                content: window.location.pathname.includes('/en') ? "Powerful and reliable pumps for water circulation" : "مضخات قوية وموثوقة لتدوير المياه",
                keywords: ["مضخة", "pump", "تدوير", "circulation", "قوية", "powerful"]
              },
              {
                title: window.location.pathname.includes('/en') ? "Heating Systems" : "أنظمة التدفئة",
                content: window.location.pathname.includes('/en') ? "Advanced heating systems for pools" : "أنظمة تدفئة متطورة للمسابح",
                keywords: ["تدفئة", "heating", "أنظمة", "systems", "متطورة", "advanced"]
              },
              {
                title: window.location.pathname.includes('/en') ? "Pool Lighting" : "إضاءة المسابح",
                content: window.location.pathname.includes('/en') ? "Advanced LED lighting for pools" : "إضاءة LED متطورة للمسابح",
                keywords: ["إضاءة", "lighting", "LED", "متطورة", "advanced"]
              }
            ]
          },
          {
            page: window.location.pathname.includes('/en') ? "Gallery" : "المعرض",
            url: window.location.pathname.includes('/en') ? "/en/gallery" : "/ar/gallery",
            sections: [
              {
                title: window.location.pathname.includes('/en') ? "Our Work" : "أعمالنا",
                content: window.location.pathname.includes('/en') ? "A collection of our best work in pool design" : "مجموعة من أفضل أعمالنا في تصميم المسابح",
                keywords: ["أعمال", "work", "تصميم", "design", "مجموعة", "collection"]
              }
            ]
          },
          {
            page: window.location.pathname.includes('/en') ? "Contact Us" : "اتصل بنا",
            url: window.location.pathname.includes('/en') ? "/en/contact" : "/ar/contact",
            sections: [
              {
                title: window.location.pathname.includes('/en') ? "Contact Information" : "معلومات التواصل",
                content: window.location.pathname.includes('/en') ? "Contact us for a free consultation" : "تواصل معنا للحصول على استشارة مجانية",
                keywords: ["تواصل", "contact", "استشارة", "consultation", "مجانية", "free"]
              }
            ]
          }
        ];
        
        // Search function
        function performSearch(query: string) {
          if (!query || !searchResults) {
            searchResults?.classList.add('hidden');
            return;
          }
          
          const searchTerm = query.toLowerCase();
          const results: any[] = [];
          
          searchableContent.forEach(page => {
            page.sections.forEach(section => {
              const titleMatch = section.title.toLowerCase().includes(searchTerm);
              const contentMatch = section.content.toLowerCase().includes(searchTerm);
              const keywordMatch = section.keywords.some(keyword => 
                keyword.toLowerCase().includes(searchTerm)
              );
              
              if (titleMatch || contentMatch || keywordMatch) {
                results.push({
                  page: page.page,
                  url: page.url,
                  section: section.title,
                  content: section.content,
                  matchType: titleMatch ? 'title' : contentMatch ? 'content' : 'keyword'
                });
              }
            });
          });
          
          displayResults(results, query);
        }
        
        // Display results
        function displayResults(results: any[], query: string) {
          if (!searchResultsContent) return;
          
          if (results.length === 0) {
            searchResultsContent.innerHTML = `
              <div class="p-4 text-center text-gray-500">
                <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p>${window.location.pathname.includes('/en') ? 'No results found' : 'لم يتم العثور على نتائج'}</p>
              </div>
            `;
          } else {
            searchResultsContent.innerHTML = results.map((result: any) => `
              <div class="p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
                <div class="flex items-start justify-between mb-1">
                  <h4 class="font-semibold text-blue-900 text-sm">
                    <a href="${result.url}" class="hover:text-blue-700">${highlightText(result.section, query)}</a>
                  </h4>
                  <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">
                    ${result.page}
                  </span>
                </div>
                <p class="text-xs text-gray-600 mb-2">${highlightText(result.content, query)}</p>
                <div class="flex items-center justify-between">
                  <a href="${result.url}" class="text-xs text-blue-600 hover:text-blue-800">
                    ${window.location.pathname.includes('/en') ? 'View Page' : 'عرض الصفحة'} →
                  </a>
                  <span class="text-xs text-gray-400">
                    ${window.location.pathname.includes('/en') ? 
                      (result.matchType === 'title' ? 'Title' : result.matchType === 'content' ? 'Content' : 'Keyword') :
                      (result.matchType === 'title' ? 'عنوان' : result.matchType === 'content' ? 'محتوى' : 'كلمة مفتاحية')
                    }
                  </span>
                </div>
              </div>
            `).join('');
          }
          
          searchResults?.classList.remove('hidden');
        }
        
        // Highlight matching text
        function highlightText(text: string, query: string) {
          return text.replace(
            new RegExp(query, 'gi'),
            `<mark class="bg-yellow-200 px-1 rounded">${query}</mark>`
          );
        }
        
        // Event listeners
        searchInput.addEventListener('input', function() {
          const query = this.value.trim();
          if (query.length > 1) {
            performSearch(query);
          } else {
            searchResults.classList.add('hidden');
          }
        });
        
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
              // Go to first result or products page
              const firstResult = searchResultsContent.querySelector('a');
              if (firstResult) {
                window.location.href = firstResult.href;
              } else {
                const currentLang = window.location.pathname.includes('/en') ? 'en' : 'ar';
                window.location.href = `/${currentLang}/products`;
              }
            }
          }
        });
        
        // Hide results when clicking outside
        document.addEventListener('click', function(e) {
          const target = e.target as Node;
          if (!searchInput.contains(target) && !searchResults.contains(target)) {
            searchResults?.classList.add('hidden');
          }
        });
        
        // Show results when focusing on input
        searchInput.addEventListener('focus', function() {
          if (this.value.trim().length > 1) {
            searchResults?.classList.remove('hidden');
          }
        });
      });
    </script>
  </body>
</html>
